services:
  postgres:
    image: postgres:18
    container_name: tv-postgres
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      POSTGRES_DB: tv
      TZ: UTC
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql
      - ./container/postgres-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root -d tv"]
      interval: 10s
      timeout: 5s
      retries: 5

  viewer:
    build:
      context: .
      dockerfile: Dockerfile
      target: release
    container_name: tv-viewer
    command: ["viewer"]
    environment:
      TV_HOST: "0.0.0.0"
      TV_PORT: "8080"
      TV_DATABASE_URL: "postgres://root:root@postgres:5432/tv?sslmode=disable"
      TV_APP_ENV: "production"
      TZ: UTC
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  recorder:
    build:
      context: .
      dockerfile: Dockerfile
      target: recorder
    container_name: tv-recorder
    command: ["recorder"]
    environment:
      TV_API_ENDPOINT: "http://viewer:8080"
      TV_POLL_INTERVAL: "2"
      TV_OUTPUT_DIR: "/outputs"
      EMACS_SOCKET_NAME: /run/user/1000/emacs/server
      DISPLAY: ${DISPLAY}
      PULSE_SERVER: unix:/run/user/1000/pulse/native
      TZ: UTC
    volumes:
      - ./backend/outputs:/outputs
      - ./backend/record_screen.sh:/workdir/record_screen.sh:ro
      # ホストマシンによって変わるだろう
      # (print server-socket-dir) で確認する
      - /run/user/1000/emacs:/run/user/1000/emacs:ro
      # X11ソケット
      - /tmp/.X11-unix:/tmp/.X11-unix:ro
      # PulseAudioソケット
      - /run/user/1000/pulse:/run/user/1000/pulse:ro
      # デバイス全体をマウント
      - /dev:/dev
    privileged: true
    depends_on:
      - viewer
    restart: unless-stopped

volumes:
  postgres-data:

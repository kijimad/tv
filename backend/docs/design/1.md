# recorder側から状況をリクエストしているのがわかりにくいのを直す

## ステータス

実装完了。

## 背景

- recorderが途中で止まるとそのままになる
- ほとんどの状態変化はrecorder内で起こる。そのたびにviewer(API)に送って管理するのは面倒である
- 止まっているのか区別がつかない。ガチでやるならハートビートみたいにしないといけないが、手間ばかりがかかる

## やること

- 状態はrecorderにもたせて、最後に完成したものだけを送るようにする
  - テーブルでは最後まで成功したデータしか登録されない
  - 現在処理中のジョブがあればUIに出す
  - ジョブの状態はオンメモリでワーカーが保持し、状態をAPIでリクエストできる

## コメント

- 外部からrecorderの処理状況を取得できるようするほうが自然である。問い合わせたいのはいつでも外部からなので
- ほとんどの場合、録画の状態を知りたいのは現在処理中の1件であり、テーブルに永続化させる必要はない
- たとえば履歴に残さないといけないような重要なデータの場合は各テーブルでやるべきだが、今回はそうではない
- データ接続して直接ログレコードを発行してもいいかもしれない
- ジョブはコード的に独立させられる
  - 入出力の情報はわずかで、実行に時間がかかるというだけという点においてのみ違う
  - 長時間かかる処理で、途中経過をUIから見たいケースは意外とあまりないかもしれない。開発する側ならみたいことは多いだろうが、普通の顧客だとあまり想像ができない
  - 独立させているために、途中処理を共有しにくくなっている
- ステータス変化を共有する方法
  - RDBMS に書き込み
  - API で通信
  - ファイル に書き込み
- 状態をDBで管理する場合、最初に不完全な状態でレコード作成しないといけないのも微妙ポイントだった。イベントを追跡するために、最初にvideosを作成してIDを得る必要がある。それを避けるために状態ごとに別テーブルにする...とかなると手間がかかる
  - その点、ワーカー内で管理するようにするとジョブIDを使えばよいので簡単である
- ワーカーの設計を体系的に考えられていない感じがする
- 非同期処理は別サービスにする理由
  - 長い処理中にワーカーの停止や再起動を避けて、APIだけデプロイできる
  - ワーカーとHTTPサーバはリソース特性が異なるので、分けておくとスケールしやすい
- pub/subが合体しているので、分けると少しわかりやすいかもしれない
  - pub: polling Emacs org-pomodoro
  - sub: 録画 or 変換 スクリプト
